<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="shortcut icon" href="/pragmaticformalmodeling/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/pragmaticformalmodeling/assets/css/just-the-docs-default.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=G-VEQJ8PBLCD"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-VEQJ8PBLCD', { 'anonymize_ip': true }); </script> <script type="text/javascript" src="/pragmaticformalmodeling/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Cache Invalidation | Pragmatic Formal Modeling</title> <meta name="generator" content="Jekyll v3.9.2" /> <meta property="og:title" content="Cache Invalidation" /> <meta name="author" content="Elliot Swart" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="An accessible deep dive into cache invalidation, going from theory to progressively refined and tested formal models. Learn how to catch cache invalidation design flaws early, and not in production." /> <meta property="og:description" content="An accessible deep dive into cache invalidation, going from theory to progressively refined and tested formal models. Learn how to catch cache invalidation design flaws early, and not in production." /> <link rel="canonical" href="https://elliotswart.github.io/pragmaticformalmodeling/caching/" /> <meta property="og:url" content="https://elliotswart.github.io/pragmaticformalmodeling/caching/" /> <meta property="og:site_name" content="Pragmatic Formal Modeling" /> <meta property="og:image" content="https://elliotswart.github.io/pragmaticformalmodeling/logo.png" /> <meta property="og:image:height" content="150" /> <meta property="og:image:width" content="150" /> <meta property="og:image:alt" content="Temporal Logic Symbol for Eventually" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary_large_image" /> <meta property="twitter:image" content="https://elliotswart.github.io/pragmaticformalmodeling/logo.png" /> <meta name="twitter:image:alt" content="Temporal Logic Symbol for Eventually" /> <meta property="twitter:title" content="Cache Invalidation" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Elliot Swart","url":"https://www.linkedin.com/in/elliotswart/"},"description":"An accessible deep dive into cache invalidation, going from theory to progressively refined and tested formal models. Learn how to catch cache invalidation design flaws early, and not in production.","headline":"Cache Invalidation","image":{"alt":"Temporal Logic Symbol for Eventually","height":150,"width":150,"url":"https://elliotswart.github.io/pragmaticformalmodeling/logo.png","@type":"imageObject"},"url":"https://elliotswart.github.io/pragmaticformalmodeling/caching/"}</script> <!-- End Jekyll SEO tag --> <link rel="icon" href="/favicon.ico" sizes="any"> <link rel="icon" href="/favicon.svg" type="image/svg+xml"> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="https://elliotswart.github.io/pragmaticformalmodeling/" class="site-title lh-tight"> Pragmatic Formal Modeling </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="https://elliotswart.github.io/pragmaticformalmodeling/" class="nav-list-link">Introduction to Pragmatic Formal Modeling</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://elliotswart.github.io/pragmaticformalmodeling/database-blob/" class="nav-list-link">Coordinating a Database and Blob Store</a><ul class="nav-list "><li class="nav-list-item "><a href="https://elliotswart.github.io/pragmaticformalmodeling/database-blob/naive/" class="nav-list-link">(Start of Process) The naive first draft</a></li><li class="nav-list-item "><a href="https://elliotswart.github.io/pragmaticformalmodeling/database-blob/improved/" class="nav-list-link">(Progressive Refinement) An improved solution</a></li><li class="nav-list-item "><a href="https://elliotswart.github.io/pragmaticformalmodeling/database-blob/working/" class="nav-list-link">(Verifying Correctness) A working solution</a></li><li class="nav-list-item "><a href="https://elliotswart.github.io/pragmaticformalmodeling/database-blob/cost-efficent/" class="nav-list-link">(Adding Requirements) A more cost efficent solution</a></li><li class="nav-list-item "><a href="https://elliotswart.github.io/pragmaticformalmodeling/database-blob/storage-cleaner-naive/" class="nav-list-link">(Implementing New Requirements) A naive update</a></li><li class="nav-list-item "><a href="https://elliotswart.github.io/pragmaticformalmodeling/database-blob/storage-cleaner-improved/" class="nav-list-link">(Implementing New Requirements) Significant improvement</a></li><li class="nav-list-item "><a href="https://elliotswart.github.io/pragmaticformalmodeling/database-blob/storage-cleaner-working/" class="nav-list-link">(Implementing New Requirements) A working update</a></li></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://elliotswart.github.io/pragmaticformalmodeling/caching/" class="nav-list-link active">Cache Invalidation</a><ul class="nav-list "><li class="nav-list-item "><a href="https://elliotswart.github.io/pragmaticformalmodeling/caching/naive-model/" class="nav-list-link">A naive model of caching</a></li><li class="nav-list-item "><a href="https://elliotswart.github.io/pragmaticformalmodeling/caching/cache-invalidation/" class="nav-list-link">Adding cache invalidation</a></li><li class="nav-list-item "><a href="https://elliotswart.github.io/pragmaticformalmodeling/caching/working-cache-invalidation/" class="nav-list-link">Working cache invalidation</a></li><li class="nav-list-item "><a href="https://elliotswart.github.io/pragmaticformalmodeling/caching/reproducing-the-bug/" class="nav-list-link">Reproducing Facebook's bug</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://elliotswart.github.io/pragmaticformalmodeling/business-logic/" class="nav-list-link">Business Logic</a><ul class="nav-list "><li class="nav-list-item "><a href="https://elliotswart.github.io/pragmaticformalmodeling/business-logic/enterprise-architect/" class="nav-list-link">Enterprise Architect gets us started</a></li><li class="nav-list-item "><a href="https://elliotswart.github.io/pragmaticformalmodeling/business-logic/junior-dev/" class="nav-list-link">Junior Developer tries their best</a></li><li class="nav-list-item "><a href="https://elliotswart.github.io/pragmaticformalmodeling/business-logic/principal-eng/" class="nav-list-link">Principal Engineer saves the day</a></li></ul></li><li class="nav-list-item"><a href="https://elliotswart.github.io/pragmaticformalmodeling/learning-material/" class="nav-list-link">Learning Material</a></li><li class="nav-list-item"><a href="https://elliotswart.github.io/pragmaticformalmodeling/tools/" class="nav-list-link">Tools and Additional Citations</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://github.com/ElliotSwart/pragmaticformalmodeling" class="site-button" target="_blank" rel="noopener noreferrer" > GitHub Repository </a> </li> <li class="aux-nav-list-item"> <a href="https://www.linkedin.com/in/elliotswart/" class="site-button" target="_blank" rel="noopener noreferrer" > About the Author </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <div id="main-content" class="main-content" role="main"> <h1 class="no_toc" id="cache-invalidation"> <a href="#cache-invalidation" class="anchor-heading" aria-labelledby="cache-invalidation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Cache Invalidation </h1> <ol id="markdown-toc"> <li><a href="#introduction" id="markdown-toc-introduction">Introduction</a></li> <li><a href="#a-simple-explainer-on-caching" id="markdown-toc-a-simple-explainer-on-caching">A simple explainer on caching</a> <ol> <li><a href="#data-access" id="markdown-toc-data-access">Data Access</a></li> <li><a href="#cached-data-access" id="markdown-toc-cached-data-access">Cached Data Access</a></li> <li><a href="#cpu-caches" id="markdown-toc-cpu-caches">CPU Caches</a></li> <li><a href="#browser-cache" id="markdown-toc-browser-cache">Browser Cache</a></li> <li><a href="#database--data-service-caching" id="markdown-toc-database--data-service-caching">Database / Data Service Caching</a> <ol> <li><a href="#cache-aside" id="markdown-toc-cache-aside">Cache-Aside</a></li> <li><a href="#read-through" id="markdown-toc-read-through">Read-Through</a></li> <li><a href="#advantages-of-database-caching" id="markdown-toc-advantages-of-database-caching">Advantages of Database Caching</a></li> </ol> </li> </ol> </li> <li><a href="#key-concepts-and-assumptions-in-database-caching" id="markdown-toc-key-concepts-and-assumptions-in-database-caching">Key concepts and assumptions in database caching</a> <ol> <li><a href="#modeling-assumptions" id="markdown-toc-modeling-assumptions">Modeling assumptions</a></li> <li><a href="#cache-eviction" id="markdown-toc-cache-eviction">Cache eviction</a></li> <li><a href="#cache-invalidation-1" id="markdown-toc-cache-invalidation-1">Cache invalidation</a></li> </ol> </li> <li><a href="#initial-parameters-for-all-exercises" id="markdown-toc-initial-parameters-for-all-exercises">Initial parameters for all exercises</a></li> <li><a href="#summary" id="markdown-toc-summary">Summary</a></li> </ol> <h2 id="introduction"> <a href="#introduction" class="anchor-heading" aria-labelledby="introduction"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Introduction </h2> <p>Caching is everywhere. Handling caches is one of the more complex and error prone parts of a developer’s life, especially when maintaining web applications. Here we will attempt to explain why, and create and debug formal models for caching strategies. Why is the title of this article “Cache Invalidation”? As it turns out, that’s the tricky part. Don’t worry if that doesn’t ring a bell yet! We’ll explain it step by step.</p> <p>This article was inspired by this <a href="https://engineering.fb.com/2022/06/08/core-data/cache-invalidation/">Facebook blog post</a> on cache invalidation. As they mention, caching behavior is best thought of as a state machine, which makes it a perfect fit for modeling. I’d recommend you read the post twice: once before and once after you read this article. It is a short and well-written intro to the nuances of caching and cache consistency testing. It’s also written by people who run caches that serve one quadrillion queries a day. One quadrillion is <strong>1,000,000,000,000,000</strong>. Statistically speaking, if a problem can happen, it will happen to them.</p> <p><em>Note: We’ll be focusing on cache reads for this article. However, we will absolutely address what happens when the underlying data is written to (which is where cache invalidation comes up).</em></p> <h2 id="a-simple-explainer-on-caching"> <a href="#a-simple-explainer-on-caching" class="anchor-heading" aria-labelledby="a-simple-explainer-on-caching"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> A simple explainer on caching </h2> <p>The simplest model of data access involves a <strong>Data Consumer</strong> and a <strong>Data Store</strong>. When the consumer wants information, it asks the store, which gives it the most up to data information it has. How simple is that?</p> <h3 id="data-access"> <a href="#data-access" class="anchor-heading" aria-labelledby="data-access"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Data Access </h3> <div class="plantuml theme-plain"><svg contentScriptType='application/ecmascript' contentStyleType='text/css' height='152px' preserveAspectRatio='none' style='width:308px;height:152px;background:#FFFFFF;' version='1.1' viewBox='0 0 308 152' width='308px' xmlns:xlink='http://www.w3.org/1999/xlink' xmlns='http://www.w3.org/2000/svg' zoomAndPan='magnify'><defs/><g><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;' x1='81' x2='81' y1='37.0146' y2='116.6133'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;' x1='257.5' x2='257.5' y1='37.0146' y2='116.6133'/><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='123' x='20' y='5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='109' x='27' y='26.0752'>Data Consumer</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='123' x='20' y='115.6133'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='109' x='27' y='136.6885'>Data Consumer</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='90' x='212.5' y='5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='76' x='219.5' y='26.0752'>Data Store</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='90' x='212.5' y='115.6133'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='76' x='219.5' y='136.6885'>Data Store</text><polygon fill='#000000' points='245.5,64.814,255.5,68.814,245.5,72.814,249.5,68.814' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;' x1='81.5' x2='251.5' y1='68.814' y2='68.814'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='152' x='88.5' y='64.0845'>Requests piece of data</text><polygon fill='#000000' points='92.5,94.6133,82.5,98.6133,92.5,102.6133,88.5,98.6133' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;' x1='86.5' x2='256.5' y1='98.6133' y2='98.6133'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='85' x='98.5' y='93.8838'>Returns data</text></g></svg></div> <h3 id="cached-data-access"> <a href="#cached-data-access" class="anchor-heading" aria-labelledby="cached-data-access"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Cached Data Access </h3> <p>For a number of reasons, especially if the data is going to be accessed often, we put a cache between the data consumer and the data store.</p> <div class="plantuml theme-plain"><svg contentScriptType='application/ecmascript' contentStyleType='text/css' height='244px' preserveAspectRatio='none' style='width:544px;height:244px;background:#FFFFFF;' version='1.1' viewBox='0 0 544 244' width='544px' xmlns:xlink='http://www.w3.org/1999/xlink' xmlns='http://www.w3.org/2000/svg' zoomAndPan='magnify'><defs/><g><rect fill='#FFFFFF' height='77.3979' style='stroke:#000000;stroke-width:1.0;' width='329' x='209.5' y='83.814'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;' x1='81' x2='81' y1='37.0146' y2='208.0112'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;' x1='257.5' x2='257.5' y1='37.0146' y2='208.0112'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;' x1='433.5' x2='433.5' y1='37.0146' y2='208.0112'/><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='123' x='20' y='5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='109' x='27' y='26.0752'>Data Consumer</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='123' x='20' y='207.0112'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='109' x='27' y='228.0864'>Data Consumer</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='56' x='229.5' y='5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='42' x='236.5' y='26.0752'>Cache</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='56' x='229.5' y='207.0112'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='42' x='236.5' y='228.0864'>Cache</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='90' x='388.5' y='5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='76' x='395.5' y='26.0752'>Data Store</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='90' x='388.5' y='207.0112'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='76' x='395.5' y='228.0864'>Data Store</text><polygon fill='#000000' points='245.5,64.814,255.5,68.814,245.5,72.814,249.5,68.814' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;' x1='81.5' x2='251.5' y1='68.814' y2='68.814'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='152' x='88.5' y='64.0845'>Requests piece of data</text><path d='M209.5,83.814 L273.5,83.814 L273.5,90.814 L263.5,100.814 L209.5,100.814 L209.5,83.814 ' fill='#FFFFFF' style='stroke:#000000;stroke-width:1.0;'/><rect fill='none' height='77.3979' style='stroke:#000000;stroke-width:1.0;' width='329' x='209.5' y='83.814'/><text fill='#000000' font-family='Verdana' font-size='13' font-weight='bold' lengthAdjust='spacing' textLength='19' x='224.5' y='97.8838'>alt</text><text fill='#000000' font-family='Verdana' font-size='11' font-weight='bold' lengthAdjust='spacing' textLength='245' x='288.5' y='96.873'>[cache doesn't have data (cache miss)]</text><polygon fill='#000000' points='421.5,119.4126,431.5,123.4126,421.5,127.4126,425.5,123.4126' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;' x1='257.5' x2='427.5' y1='123.4126' y2='123.4126'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='152' x='264.5' y='118.6831'>Requests piece of data</text><polygon fill='#000000' points='268.5,149.2119,258.5,153.2119,268.5,157.2119,264.5,153.2119' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;' x1='262.5' x2='432.5' y1='153.2119' y2='153.2119'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='85' x='274.5' y='148.4824'>Returns data</text><polygon fill='#000000' points='92.5,186.0112,82.5,190.0112,92.5,194.0112,88.5,190.0112' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;' x1='86.5' x2='256.5' y1='190.0112' y2='190.0112'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='85' x='98.5' y='185.2817'>Returns data</text></g></svg></div> <p>Wow, that’s way more complicated! Spoiler alert, there are way more failures that can occur due to that complexity. So why do we use it? Did Big Cache lobby Congress? Actually, there are profound benefits to caching. The main ones are higher speed and lower cost. Let’s look at different examples of caches.</p> <h3 id="cpu-caches"> <a href="#cpu-caches" class="anchor-heading" aria-labelledby="cpu-caches"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> CPU Caches </h3> <div class="plantuml theme-plain"><svg contentScriptType='application/ecmascript' contentStyleType='text/css' height='244px' preserveAspectRatio='none' style='width:666px;height:244px;background:#FFFFFF;' version='1.1' viewBox='0 0 666 244' width='666px' xmlns:xlink='http://www.w3.org/1999/xlink' xmlns='http://www.w3.org/2000/svg' zoomAndPan='magnify'><defs/><g><rect fill='#FFFFFF' height='77.3979' style='stroke:#000000;stroke-width:1.0;' width='402' x='258.5' y='83.814'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;' x1='59' x2='59' y1='37.0146' y2='208.0112'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;' x1='332.5' x2='332.5' y1='37.0146' y2='208.0112'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;' x1='605.5' x2='605.5' y1='37.0146' y2='208.0112'/><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='79' x='20' y='5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='65' x='27' y='26.0752'>CPU Core</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='79' x='20' y='207.0112'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='65' x='27' y='228.0864'>CPU Core</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='108' x='278.5' y='5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='94' x='285.5' y='26.0752'>L1-L3 Caches</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='108' x='278.5' y='207.0112'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='94' x='285.5' y='228.0864'>L1-L3 Caches</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='70' x='570.5' y='5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='56' x='577.5' y='26.0752'>Memory</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='70' x='570.5' y='207.0112'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='56' x='577.5' y='228.0864'>Memory</text><polygon fill='#000000' points='320.5,64.814,330.5,68.814,320.5,72.814,324.5,68.814' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;' x1='59.5' x2='326.5' y1='68.814' y2='68.814'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='249' x='66.5' y='64.0845'>Requests data from memory address</text><path d='M258.5,83.814 L322.5,83.814 L322.5,90.814 L312.5,100.814 L258.5,100.814 L258.5,83.814 ' fill='#FFFFFF' style='stroke:#000000;stroke-width:1.0;'/><rect fill='none' height='77.3979' style='stroke:#000000;stroke-width:1.0;' width='402' x='258.5' y='83.814'/><text fill='#000000' font-family='Verdana' font-size='13' font-weight='bold' lengthAdjust='spacing' textLength='19' x='273.5' y='97.8838'>alt</text><text fill='#000000' font-family='Verdana' font-size='11' font-weight='bold' lengthAdjust='spacing' textLength='80' x='337.5' y='96.873'>[cache miss]</text><polygon fill='#000000' points='593.5,119.4126,603.5,123.4126,593.5,127.4126,597.5,123.4126' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;' x1='332.5' x2='599.5' y1='123.4126' y2='123.4126'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='249' x='339.5' y='118.6831'>Requests data from memory address</text><polygon fill='#000000' points='343.5,149.2119,333.5,153.2119,343.5,157.2119,339.5,153.2119' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;' x1='337.5' x2='604.5' y1='153.2119' y2='153.2119'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='85' x='349.5' y='148.4824'>Returns data</text><polygon fill='#000000' points='70.5,186.0112,60.5,190.0112,70.5,194.0112,66.5,190.0112' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;' x1='64.5' x2='331.5' y1='190.0112' y2='190.0112'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='85' x='76.5' y='185.2817'>Returns data</text></g></svg></div><blockquote> <p><em>Note: L1-L3 caches are grouped in the diagram. Actual data access goes from Core -&gt; L1 -&gt; L2 -&gt; L3 -&gt; Memory</em></p> </blockquote> <p>Perhaps the most important caches in all of computer engineering are those located on the CPU and used to access <strong>Memory</strong>.</p> <p>The caches are located on the CPU, with L1 and L2 caches generally located on each individual core. The closer a cache is to a core, the faster it is to access: <img src="cpucaches.png" alt="A CPU die. The caches are marked, showing the L1 cache co-located each core, the L2 cache further away but still associated with a core, and the L3 cache furthest away and shared among all cores." /><br /> <a href="https://superuser.com/a/507477">(credit)</a></p> <p>Advantages:</p> <ul> <li>Higher speed: Getting data from an L1 cache is approximately 100x faster than getting it from memory. That matters a lot for data that is actively worked on by the processor.</li> <li>Lower cost: Caching reduces the amount of times the core needs to access memory. However, lowering cost is not the primary reason for this kind of cache.</li> </ul> <p>CPU caches are an example of Read Through caches because the CPU talks to the cache that talks to the memory. They are also <a href="https://www.geeksforgeeks.org/write-through-and-write-back-in-cache/">Write Through</a> caches, though that is not covered here. If you are interested in this kind of caching, check out <a href="https://lamport.azurewebsites.net/tla/book.html?back-link=learning.html#book">Specifying Systems</a>: <strong>Pages 56-64</strong>. It also addresses writing, which is the more complicated use case.</p> <h3 id="browser-cache"> <a href="#browser-cache" class="anchor-heading" aria-labelledby="browser-cache"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Browser Cache </h3> <div class="plantuml theme-plain"><svg contentScriptType='application/ecmascript' contentStyleType='text/css' height='391px' preserveAspectRatio='none' style='width:623px;height:391px;background:#FFFFFF;' version='1.1' viewBox='0 0 623 391' width='623px' xmlns:xlink='http://www.w3.org/1999/xlink' xmlns='http://www.w3.org/2000/svg' zoomAndPan='magnify'><defs/><g><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;' x1='61' x2='61' y1='37.0146' y2='355.0078'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;' x1='216.5' x2='216.5' y1='37.0146' y2='355.0078'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;' x1='432' x2='432' y1='37.0146' y2='355.0078'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;' x1='569' x2='569' y1='37.0146' y2='355.0078'/><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='83' x='20' y='5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='69' x='27' y='26.0752'>Web Page</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='83' x='20' y='354.0078'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='69' x='27' y='375.083'>Web Page</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='70' x='181.5' y='5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='56' x='188.5' y='26.0752'>Browser</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='70' x='181.5' y='354.0078'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='56' x='188.5' y='375.083'>Browser</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='117' x='374' y='5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='103' x='381' y='26.0752'>Browser Cache</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='117' x='374' y='354.0078'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='103' x='381' y='375.083'>Browser Cache</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='96' x='521' y='5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='82' x='528' y='26.0752'>Web Server</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='96' x='521' y='354.0078'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='82' x='528' y='375.083'>Web Server</text><polygon fill='#000000' points='204.5,64.814,214.5,68.814,204.5,72.814,208.5,68.814' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;' x1='61.5' x2='210.5' y1='68.814' y2='68.814'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='131' x='68.5' y='64.0845'>Accesses image.jpg</text><polygon fill='#000000' points='420.5,94.6133,430.5,98.6133,420.5,102.6133,424.5,98.6133' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;' x1='216.5' x2='426.5' y1='98.6133' y2='98.6133'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='192' x='223.5' y='93.8838'>Checks if image.jpg in cache</text><polygon fill='#000000' points='227.5,124.4126,217.5,128.4126,227.5,132.4126,223.5,128.4126' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;' x1='221.5' x2='431.5' y1='128.4126' y2='128.4126'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='139' x='233.5' y='123.6831'>Doesn't find in cache</text><polygon fill='#000000' points='557,154.2119,567,158.2119,557,162.2119,561,158.2119' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;' x1='216.5' x2='563' y1='158.2119' y2='158.2119'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='131' x='223.5' y='153.4824'>Requests image.jpg</text><polygon fill='#000000' points='227.5,184.0112,217.5,188.0112,227.5,192.0112,223.5,188.0112' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;' x1='221.5' x2='568' y1='188.0112' y2='188.0112'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='122' x='233.5' y='183.2817'>Returns image.jpg</text><polygon fill='#000000' points='72.5,213.8105,62.5,217.8105,72.5,221.8105,68.5,217.8105' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;' x1='66.5' x2='215.5' y1='217.8105' y2='217.8105'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='122' x='78.5' y='213.0811'>Returns image.jpg</text><polygon fill='#000000' points='204.5,243.6099,214.5,247.6099,204.5,251.6099,208.5,247.6099' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;' x1='61.5' x2='210.5' y1='247.6099' y2='247.6099'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='131' x='68.5' y='242.8804'>Accesses image.jpg</text><polygon fill='#000000' points='420.5,273.4092,430.5,277.4092,420.5,281.4092,424.5,277.4092' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;' x1='216.5' x2='426.5' y1='277.4092' y2='277.4092'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='192' x='223.5' y='272.6797'>Checks if image.jpg in cache</text><polygon fill='#000000' points='227.5,303.2085,217.5,307.2085,227.5,311.2085,223.5,307.2085' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;' x1='221.5' x2='431.5' y1='307.2085' y2='307.2085'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='122' x='233.5' y='302.479'>Returns image.jpg</text><polygon fill='#000000' points='72.5,333.0078,62.5,337.0078,72.5,341.0078,68.5,337.0078' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;' x1='66.5' x2='215.5' y1='337.0078' y2='337.0078'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='122' x='78.5' y='332.2783'>Returns image.jpg</text></g></svg></div><p>Browser caches are the type of cache with which your average person has the most interaction. Web browsers such as Chrome maintain a cache of assets they download from the web.</p> <p>Advantages:</p> <ul> <li>Higher speed: Don’t need to download large files every time you visit a website or change pages.</li> <li>Lower cost: Reduces the load on the servers because they don’t need to repeatedly serve the largest, and thus most expensive, files.</li> </ul> <p>Browser caching is an example of a <a href="https://docs.microsoft.com/en-us/azure/architecture/patterns/cache-aside">Cache-aside</a> pattern, where the application is responsible for managing the cache.</p> <blockquote> <p><em>While this is critical to the modern web, it can cause strange problems if it is used even slightly incorrectly. There’s a reason the first suggestion when a website stops working is to clear your cache.</em></p> </blockquote> <h3 id="database--data-service-caching"> <a href="#database--data-service-caching" class="anchor-heading" aria-labelledby="database--data-service-caching"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Database / Data Service Caching </h3> <p>This is the type of cache we’ll be focusing on in this article. Databases are expensive and hard to scale, and they are also generally a performance bottleneck. So you put a cache in between your web servers and your database. You see both Cache-Aside and Read Through caching here.</p> <h4 id="cache-aside"> <a href="#cache-aside" class="anchor-heading" aria-labelledby="cache-aside"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Cache-Aside </h4> <p>This is the most common. We are trying to cache database queries, and there is no “right” way to do that. For a simple example, let’s say we wanted to get the names of all employees located in Palo Alto. The query might look like:</p> <blockquote> <p>Query.SQL: <strong>SELECT Names FROM EMPLOYEES WHERE Location=’Palo Alto’</strong></p> </blockquote> <p>Ok, that’s probably not going to meaningfully change on a second by second basis, so there’s no need to keep hitting the database. Our system looks like this:</p> <div class="plantuml theme-plain"><svg contentScriptType='application/ecmascript' contentStyleType='text/css' height='168px' preserveAspectRatio='none' style='width:546px;height:168px;background:#FFFFFF;' version='1.1' viewBox='0 0 546 168' width='546px' xmlns:xlink='http://www.w3.org/1999/xlink' xmlns='http://www.w3.org/2000/svg' zoomAndPan='magnify'><defs/><g><!--MD5=[b1435b213846e3ddcd1e6c1cd6b83b9a] entity Server--><rect fill='#FFFFFF' height='47.0146' style='stroke:#000000;stroke-width:1.0;' width='122' x='12' y='58.5'/><rect fill='#FFFFFF' height='10' style='stroke:#000000;stroke-width:1.0;' width='15' x='114' y='63.5'/><rect fill='#FFFFFF' height='2' style='stroke:#000000;stroke-width:1.0;' width='4' x='112' y='65.5'/><rect fill='#FFFFFF' height='2' style='stroke:#000000;stroke-width:1.0;' width='4' x='112' y='69.5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='82' x='27' y='92.5752'>Web Server</text><!--MD5=[7f2f8f021ba496bad1f94a1981c7f515] entity Cache--><rect fill='#FFFFFF' height='47.0146' style='stroke:#000000;stroke-width:1.0;' width='122' x='418' y='105.5'/><rect fill='#FFFFFF' height='10' style='stroke:#000000;stroke-width:1.0;' width='15' x='520' y='110.5'/><rect fill='#FFFFFF' height='2' style='stroke:#000000;stroke-width:1.0;' width='4' x='518' y='112.5'/><rect fill='#FFFFFF' height='2' style='stroke:#000000;stroke-width:1.0;' width='4' x='518' y='116.5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='82' x='433' y='139.5752'>Memcached</text><!--MD5=[fa1e3283224feb76407c84b7e90ed808] entity Database--><path d='M436.5,21 C436.5,11 479,11 479,11 C479,11 521.5,11 521.5,21 L521.5,47.0146 C521.5,57.0146 479,57.0146 479,57.0146 C479,57.0146 436.5,57.0146 436.5,47.0146 L436.5,21 ' fill='#FFFFFF' style='stroke:#000000;stroke-width:1.0;'/><path d='M436.5,21 C436.5,31 479,31 479,31 C479,31 521.5,31 521.5,21 ' fill='none' style='stroke:#000000;stroke-width:1.0;'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='65' x='446.5' y='49.0752'>Database</text><!--MD5=[f0a1e61810f8a465ab4af215da9075dc] entity DatabaseConnection--><ellipse cx='276' cy='34' fill='#FFFFFF' rx='8' ry='8' style='stroke:#000000;stroke-width:1.0;'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='148' x='202' y='65.0752'>Database Connection</text><!--MD5=[06cbbc33bded0354d9f6a8e4fea7cbd9] entity CacheConnection--><ellipse cx='276' cy='129' fill='#FFFFFF' rx='8' ry='8' style='stroke:#000000;stroke-width:1.0;'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='126' x='213' y='160.0752'>Read/Write Cache</text><!--MD5=[1984277cbb7cfca4276383c4422ffad4] link CacheConnection to Cache--><path d='M285.13,129 C307.24,129 370.01,129 417.99,129 ' fill='none' id='CacheConnection-Cache' style='stroke:#000000;stroke-width:1.0;'/><!--MD5=[ecc7b5d5a21b074a3ca1bd354e020661] link DatabaseConnection to Database--><path d='M285.13,34 C310.17,34 387.41,34 436.21,34 ' fill='none' id='DatabaseConnection-Database' style='stroke:#000000;stroke-width:1.0;'/><!--MD5=[9f28f7c58906572c0cec18c14243de3a] link Server to CacheConnection--><path d='M134.03,96.04 C178.75,106.49 236.28,119.95 261.8,125.91 ' fill='none' id='Server-to-CacheConnection' style='stroke:#000000;stroke-width:1.0;'/><polygon fill='#000000' points='266.75,127.07,258.9015,121.1201,261.8822,125.928,257.0743,128.9086,266.75,127.07' style='stroke:#000000;stroke-width:1.0;'/><!--MD5=[f1c12f948c45d475696760d376eba62b] link Server to DatabaseConnection--><path d='M134.03,67.66 C178.75,56.99 236.28,43.25 261.8,37.15 ' fill='none' id='Server-to-DatabaseConnection' style='stroke:#000000;stroke-width:1.0;'/><polygon fill='#000000' points='266.75,35.97,257.068,34.1646,261.8861,37.1287,258.922,41.9468,266.75,35.97' style='stroke:#000000;stroke-width:1.0;'/></g></svg></div> <p>The database is a standard relational database. Memcached is a key value store. We use the entire query string as the key, and the result of the query as the value.</p> <div class="plantuml theme-plain"><svg contentScriptType='application/ecmascript' contentStyleType='text/css' height='301px' preserveAspectRatio='none' style='width:645px;height:301px;background:#FFFFFF;' version='1.1' viewBox='0 0 645 301' width='645px' xmlns:xlink='http://www.w3.org/1999/xlink' xmlns='http://www.w3.org/2000/svg' zoomAndPan='magnify'><defs/><g><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;' x1='68' x2='68' y1='37.0146' y2='265.6099'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;' x1='482' x2='482' y1='37.0146' y2='265.6099'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;' x1='599' x2='599' y1='37.0146' y2='265.6099'/><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='96' x='20' y='5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='82' x='27' y='26.0752'>Web Server</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='96' x='20' y='264.6099'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='82' x='27' y='285.6851'>Web Server</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='96' x='434' y='5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='82' x='441' y='26.0752'>Memcached</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='96' x='434' y='264.6099'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='82' x='441' y='285.6851'>Memcached</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='79' x='560' y='5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='65' x='567' y='26.0752'>Database</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='79' x='560' y='264.6099'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='65' x='567' y='285.6851'>Database</text><polygon fill='#000000' points='470,64.814,480,68.814,470,72.814,474,68.814' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;' x1='68' x2='476' y1='68.814' y2='68.814'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='334' x='75' y='64.0845'>Checks if contents of Query.SQL is a key in cache</text><polygon fill='#000000' points='79,94.6133,69,98.6133,79,102.6133,75,98.6133' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;' x1='73' x2='481' y1='98.6133' y2='98.6133'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='139' x='85' y='93.8838'>Doesn't find in cache</text><polygon fill='#000000' points='587.5,124.4126,597.5,128.4126,587.5,132.4126,591.5,128.4126' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;' x1='68' x2='593.5' y1='128.4126' y2='128.4126'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='194' x='75' y='123.6831'>Runs Query.SQL on database</text><polygon fill='#000000' points='79,154.2119,69,158.2119,79,162.2119,75,158.2119' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;' x1='73' x2='598.5' y1='158.2119' y2='158.2119'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='163' x='85' y='153.4824'>Returns the query result</text><polygon fill='#000000' points='470,184.0112,480,188.0112,470,192.0112,474,188.0112' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;' x1='68' x2='476' y1='188.0112' y2='188.0112'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='390' x='75' y='183.2817'>Writes the pair &lt;&lt;contents of Query.SQL, query result&gt;&gt;</text><polygon fill='#000000' points='470,213.8105,480,217.8105,470,221.8105,474,217.8105' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;' x1='68' x2='476' y1='217.8105' y2='217.8105'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='334' x='75' y='213.0811'>Checks if contents of Query.SQL is a key in cache</text><polygon fill='#000000' points='79,243.6099,69,247.6099,79,251.6099,75,247.6099' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;' x1='73' x2='481' y1='247.6099' y2='247.6099'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='137' x='85' y='242.8804'>Returns query result</text></g></svg></div> <p>While potentially you could program a cache like this one to be Read Through, maybe using the query string as a key, it could be a really bad design decision for your workload. Maybe it’s better to break it up. This is an application level decision.</p> <h4 id="read-through"> <a href="#read-through" class="anchor-heading" aria-labelledby="read-through"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Read-Through </h4> <p>If you have more homogenous ways of accessing your data, a read through cache becomes possible. The biggest example of this is the <a href="https://www.usenix.org/system/files/conference/atc13/atc13-bronson.pdf">TAO</a> graph cache developed by Facebook. While the query language for TAO is not <a href="https://graphql.org/">GraphQL</a>, it’s probably not a bad way to think of it. A more semantic, structured lookup language allows you to make company-wide decisions on how to cache, rather than just application-level. To steal an example from the paper, if you wanted to know the number of location checkins at the Golden Gate Bridge, the query might look like this:</p> <blockquote> <p><strong>assoc count(534, CHECKIN)</strong></p> </blockquote> <p>Facebook’s system looks like this:</p> <div class="plantuml theme-plain"><svg contentScriptType='application/ecmascript' contentStyleType='text/css' height='153px' preserveAspectRatio='none' style='width:964px;height:153px;background:#FFFFFF;' version='1.1' viewBox='0 0 964 153' width='964px' xmlns:xlink='http://www.w3.org/1999/xlink' xmlns='http://www.w3.org/2000/svg' zoomAndPan='magnify'><defs/><g><!--MD5=[b1435b213846e3ddcd1e6c1cd6b83b9a] entity Server--><rect fill='#FFFFFF' height='47.0146' style='stroke:#000000;stroke-width:1.0;' width='129' x='12' y='43.5'/><rect fill='#FFFFFF' height='10' style='stroke:#000000;stroke-width:1.0;' width='15' x='121' y='48.5'/><rect fill='#FFFFFF' height='2' style='stroke:#000000;stroke-width:1.0;' width='4' x='119' y='50.5'/><rect fill='#FFFFFF' height='2' style='stroke:#000000;stroke-width:1.0;' width='4' x='119' y='54.5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='89' x='27' y='77.5752'>Web Servers</text><!--MD5=[7f2f8f021ba496bad1f94a1981c7f515] entity Cache--><rect fill='#FFFFFF' height='47.0146' style='stroke:#000000;stroke-width:1.0;' width='112' x='383' y='43.5'/><rect fill='#FFFFFF' height='10' style='stroke:#000000;stroke-width:1.0;' width='15' x='475' y='48.5'/><rect fill='#FFFFFF' height='2' style='stroke:#000000;stroke-width:1.0;' width='4' x='473' y='50.5'/><rect fill='#FFFFFF' height='2' style='stroke:#000000;stroke-width:1.0;' width='4' x='473' y='54.5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='72' x='398' y='77.5752'>Tao Cache</text><!--MD5=[d0be4d613e1b5b1a4cf9146a2f10d509] entity Databases--><rect fill='#FFFFFF' height='47.0146' style='stroke:#000000;stroke-width:1.0;' width='243' x='715' y='43.5'/><rect fill='#FFFFFF' height='10' style='stroke:#000000;stroke-width:1.0;' width='15' x='938' y='48.5'/><rect fill='#FFFFFF' height='2' style='stroke:#000000;stroke-width:1.0;' width='4' x='936' y='50.5'/><rect fill='#FFFFFF' height='2' style='stroke:#000000;stroke-width:1.0;' width='4' x='936' y='54.5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='203' x='730' y='77.5752'>Database(s) and Data Stores</text><!--MD5=[f0a1e61810f8a465ab4af215da9075dc] entity DatabaseConnection--><ellipse cx='605' cy='67' fill='#FFFFFF' rx='8' ry='8' style='stroke:#000000;stroke-width:1.0;'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='85' x='562.5' y='98.0752'>Connections</text><!--MD5=[ca234cc1739b39be117b153d7965da59] entity ObjectAPI--><ellipse cx='262' cy='19' fill='#FFFFFF' rx='8' ry='8' style='stroke:#000000;stroke-width:1.0;'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='75' x='224.5' y='50.0752'>Object API</text><!--MD5=[d6b7ce8e5f817d4aa2db5594de38bafe] entity AssociationAPI--><ellipse cx='262' cy='114' fill='#FFFFFF' rx='8' ry='8' style='stroke:#000000;stroke-width:1.0;'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='107' x='208.5' y='145.0752'>Association API</text><!--MD5=[bc1ceb6f4a3308655b38b2e236d95707] link AssociationAPI to Cache--><path d='M271.44,111.73 C291.31,106.4 342.4,92.68 382.8,81.83 ' fill='none' id='AssociationAPI-Cache' style='stroke:#000000;stroke-width:1.0;'/><!--MD5=[ad76d8df60a02d732c137b8bbd7a4dd8] link ObjectAPI to Cache--><path d='M271.44,21.32 C291.31,26.76 342.4,40.78 382.8,51.86 ' fill='none' id='ObjectAPI-Cache' style='stroke:#000000;stroke-width:1.0;'/><!--MD5=[56de58ffc67aa67db711628033cc3e25] link DatabaseConnection to Databases--><path d='M614.17,67 C631.22,67 672.53,67 714.91,67 ' fill='none' id='DatabaseConnection-Databases' style='stroke:#000000;stroke-width:1.0;'/><!--MD5=[de45ea8be3b80a051e7ca692938ad24c] link Cache to DatabaseConnection--><path d='M495.07,67 C529.09,67 570.07,67 590.72,67 ' fill='none' id='Cache-to-DatabaseConnection' style='stroke:#000000;stroke-width:1.0;'/><polygon fill='#000000' points='595.99,67,586.99,63,590.99,67,586.99,71,595.99,67' style='stroke:#000000;stroke-width:1.0;'/><!--MD5=[0584c5afca68db3c4a12a420a74791bf] link Server to ObjectAPI--><path d='M141.16,50.35 C179.72,40.26 225.59,28.26 247.74,22.47 ' fill='none' id='Server-to-ObjectAPI' style='stroke:#000000;stroke-width:1.0;'/><polygon fill='#000000' points='252.84,21.14,243.1225,19.5366,248.0013,22.3998,245.1382,27.2786,252.84,21.14' style='stroke:#000000;stroke-width:1.0;'/><!--MD5=[c6f7a9c0938cacf09bd56acc72d1fe5c] link Server to AssociationAPI--><path d='M141.16,83.31 C179.72,93.18 225.59,104.93 247.74,110.6 ' fill='none' id='Server-to-AssociationAPI' style='stroke:#000000;stroke-width:1.0;'/><polygon fill='#000000' points='252.84,111.91,245.1168,105.7983,247.9969,110.6671,243.1282,113.5472,252.84,111.91' style='stroke:#000000;stroke-width:1.0;'/></g></svg></div> <p>The TAO cache is the only actor the web servers talk to. It caches the data required to answer the query and returns it to the server. Because it understands the semantics of the query, it might be able to answer more with the data it just cached, like: “Has Debra been to the golden gate bridge?”</p> <div class="plantuml theme-plain"><svg contentScriptType='application/ecmascript' contentStyleType='text/css' height='286px' preserveAspectRatio='none' style='width:859px;height:286px;background:#FFFFFF;' version='1.1' viewBox='0 0 859 286' width='859px' xmlns:xlink='http://www.w3.org/1999/xlink' xmlns='http://www.w3.org/2000/svg' zoomAndPan='magnify'><defs/><g><rect fill='#FFFFFF' height='120.1973' style='stroke:#000000;stroke-width:1.0;' width='520' x='333' y='83.814'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;' x1='68' x2='68' y1='37.0146' y2='250.8105'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;' x1='396' x2='396' y1='37.0146' y2='250.8105'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;' x1='790' x2='790' y1='37.0146' y2='250.8105'/><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='96' x='20' y='5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='82' x='27' y='26.0752'>Web Server</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='96' x='20' y='249.8105'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='82' x='27' y='270.8857'>Web Server</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='86' x='353' y='5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='72' x='360' y='26.0752'>Tao Cache</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='86' x='353' y='249.8105'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='72' x='360' y='270.8857'>Tao Cache</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='86' x='747' y='5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='72' x='754' y='26.0752'>Databases</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='86' x='747' y='249.8105'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='72' x='754' y='270.8857'>Databases</text><polygon fill='#000000' points='384,64.814,394,68.814,384,72.814,388,68.814' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;' x1='68' x2='390' y1='68.814' y2='68.814'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='304' x='75' y='64.0845'>Requests "query assoc count(534, CHECKIN)"</text><path d='M333,83.814 L397,83.814 L397,90.814 L387,100.814 L333,100.814 L333,83.814 ' fill='#FFFFFF' style='stroke:#000000;stroke-width:1.0;'/><rect fill='none' height='120.1973' style='stroke:#000000;stroke-width:1.0;' width='520' x='333' y='83.814'/><text fill='#000000' font-family='Verdana' font-size='13' font-weight='bold' lengthAdjust='spacing' textLength='19' x='348' y='97.8838'>alt</text><text fill='#000000' font-family='Verdana' font-size='11' font-weight='bold' lengthAdjust='spacing' textLength='80' x='412' y='96.873'>[cache miss]</text><polygon fill='#000000' points='778,119.4126,788,123.4126,778,127.4126,782,123.4126' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;' x1='396' x2='784' y1='123.4126' y2='123.4126'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='370' x='403' y='118.6831'>Requests all needed data from all applicable databases</text><polygon fill='#000000' points='407,149.2119,397,153.2119,407,157.2119,403,153.2119' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;' x1='401' x2='789' y1='153.2119' y2='153.2119'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='85' x='413' y='148.4824'>Returns data</text><line style='stroke:#000000;stroke-width:1.0;' x1='396' x2='438' y1='183.0112' y2='183.0112'/><line style='stroke:#000000;stroke-width:1.0;' x1='438' x2='438' y1='183.0112' y2='196.0112'/><line style='stroke:#000000;stroke-width:1.0;' x1='397' x2='438' y1='196.0112' y2='196.0112'/><polygon fill='#000000' points='407,192.0112,397,196.0112,407,200.0112,403,196.0112' style='stroke:#000000;stroke-width:1.0;'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='206' x='403' y='178.2817'>Intelligently caches graph data</text><polygon fill='#000000' points='79,228.8105,69,232.8105,79,236.8105,75,232.8105' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;' x1='73' x2='395' y1='232.8105' y2='232.8105'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='85' x='85' y='228.0811'>Returns data</text></g></svg></div> <blockquote> <p><em>Read Through caching is much better than Cache-aside if you can use it. It’s also cleaner to model and analyze, so we’ll be using it for the following models. In addition, Facebook allows Write-Through with the Tao cache, which, is out of the scope of this article to preserve the reader’s sanity.</em></p> </blockquote> <h4 id="advantages-of-database-caching"> <a href="#advantages-of-database-caching" class="anchor-heading" aria-labelledby="advantages-of-database-caching"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Advantages of Database Caching </h4> <p>Why is this type of caching so important to backend engineers?</p> <ul> <li><strong>Higher performance</strong>: A database query can take 3ms to 5 seconds depending on its structure. A memcached query can take &lt; 1ms and is consistently fast.</li> <li> <p><strong>Lower cost</strong>: This is the big one! Let’s do some back of the envelope calculations on cost:</p> <blockquote> <p>Facebook handles <em>1e15 queries per day</em>. There are <em>86,400 seconds per day</em>. <em>We can round that to 1e10 queries per second</em>.</p> </blockquote> <blockquote> <p>A 3 node postgres cluster, tuned for performance, can perform <em>5,000 queries per second</em>. Let’s call it <em>2,000 queries per second per node</em>. We’re going to ignore the difficulties of scaling databases and assume we have REALLY good sharding. If we were serving everything from the database, we would need about 5 million servers. If we say each node costs $2,000 per year to run, that’s <em>$10 billion per year</em>.</p> </blockquote> <blockquote> <p>A memcached node can handle approx <em>200,000 queries per second</em>. We would need a much more manageable 50,000 servers. At $2,000 per node a year, that comes out to the positively bargain price of <em>$100 million dollars per year</em>.</p> </blockquote> <p>Caching may be a hard problem, but it is absolutely critical to making SaaS products cost-effective. Your company may not be playing for Facebook-level stakes, but it can absolutely make a difference once a reasonable level of scale has been reached. <em><a href="https://xkcd.com">xkcd</a> gets it:</em></p> <p><img src="xkcd_the_cloud.png" alt="xkcd on caching" /></p> </li> </ul> <h2 id="key-concepts-and-assumptions-in-database-caching"> <a href="#key-concepts-and-assumptions-in-database-caching" class="anchor-heading" aria-labelledby="key-concepts-and-assumptions-in-database-caching"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Key concepts and assumptions in database caching </h2> <blockquote> <p><em>Note: Some of this can apply to other kinds of caches, but extrapolate at your own risk.</em></p> </blockquote> <p>While we covered the read case in some detail, there are several other considerations that will need to make it into every model.</p> <h3 id="modeling-assumptions"> <a href="#modeling-assumptions" class="anchor-heading" aria-labelledby="modeling-assumptions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Modeling assumptions </h3> <p>We will be assuming a Read-Through cache for the following models. While this is not the most common type of cache for this purpose, all the cache consistency issues that apply to Read-Through caches also apply to Cache-aside caches. This choice lets us skip past the application-level decisions made by Cache-aside caches. With that said, this article may still help you if you want to model a Cache-aside cache for your specific application.</p> <h3 id="cache-eviction"> <a href="#cache-eviction" class="anchor-heading" aria-labelledby="cache-eviction"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Cache eviction </h3> <p>Ok, I cached an item. Does it live in my cache forever? No, and there are two main reasons for this:</p> <ul> <li> <p>Your cache is full: Imagine a 10GB cache fronting a 1TB database. At any one time 1/100th of the data can be cached for quick access. What happens when you need to cache something new? It depends on the caching strategy, but <a href="https://en.wikipedia.org/wiki/Cache_replacement_policies#Least_recently_used_(LRU)">Least-Recently-Used (LRU)</a> is a standard one. When you need to remove data to add new data, remove the data that has been least recently read. Generally, that will let more relevant data stay in the cache, while less relevant data is evicted. This is important even for giant cache systems spanning thousands of machines. Maybe the North American cache can hold 95% of all the data North Americans want to see, but that 95% keeps changing, so the cache must change with it.</p> </li> <li> <p>Time to Live (TTL): One simple way to keep your cache up to date is to set a TTL policy. Imagine you never wanted your data to be more than 1 hour out of date. Set a TTL of 1 hour, and after an hour, the data will be retrieved again. This is a blunt but powerful tool.</p> </li> <li> <p>Accidental Eviction: Caches are generally not built for durability. A cache server can fail, potentially removing the keys it held from the cache. Replication can help with this, but in general caches choose to give up durability for performance. Durability is what the database is for.</p> </li> </ul> <p>In general, we should assume a cached item could be evicted at any time for any reason. That doesn’t mean we can’t model specific reasons for eviction, but we also need to account for random eviction.</p> <h3 id="cache-invalidation-1"> <a href="#cache-invalidation-1" class="anchor-heading" aria-labelledby="cache-invalidation-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Cache invalidation </h3> <p>As convenient as it would be if people only read from databases, it turns out that people write to them too. Which means the database values change. Which means the cache can become out of date. If the cache needed to be immediately consistent with the database it would effectively need to be an extension of the database, with all the accompanying complexity and <a href="https://en.wikipedia.org/wiki/CAP_theorem">CAP theorem</a> scaling difficulties. Databases do this, but it is hidden behind the standard database interface, and not what we’re discussing right now. The standard database caches and caching strategies aim to be <a href="https://en.wikipedia.org/wiki/Eventual_consistency">eventually consistent</a>, meaning that given time, the data in the cache will reflect the data in the database (unless of course the database changes again).</p> <p>Theoretically, eventual consistency means your cache could be minutes, hours, or even days behind the database as long as it would eventually catch up. In practice, seconds to minutes are considered acceptable. However, setting a very short TTL reduces the benefit of caching. Some applications can work with a longer TTL if updates that depend on old versions of the data are detected and cause a user error and a cache refresh. For example, choosing a seat on a air flight might show a out of date seat map, but an attempt to book seat that is filled will be caught and the user will be asked to rebook. In many systems, though, this is not a desirable property. Twitter wants to show you the latest Tweets.</p> <p>For that reason, automatic cache invalidation systems exist. Generally, one or more applications read the database logs and look for changes. The application then broadcasts to the caches that a change has occurred and they should evict their old value. The next time someone queries for that data, the cache will read through to the database and get the latest value.</p> <h2 id="initial-parameters-for-all-exercises"> <a href="#initial-parameters-for-all-exercises" class="anchor-heading" aria-labelledby="initial-parameters-for-all-exercises"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Initial parameters for all exercises </h2> <p>We will work with the simple Read-Through cache below:</p> <div class="plantuml theme-plain"><svg contentScriptType='application/ecmascript' contentStyleType='text/css' height='75px' preserveAspectRatio='none' style='width:754px;height:75px;background:#FFFFFF;' version='1.1' viewBox='0 0 754 75' width='754px' xmlns:xlink='http://www.w3.org/1999/xlink' xmlns='http://www.w3.org/2000/svg' zoomAndPan='magnify'><defs/><g><!--MD5=[b1435b213846e3ddcd1e6c1cd6b83b9a] entity Server--><rect fill='#FFFFFF' height='47.0146' style='stroke:#000000;stroke-width:1.0;' width='129' x='12' y='12'/><rect fill='#FFFFFF' height='10' style='stroke:#000000;stroke-width:1.0;' width='15' x='121' y='17'/><rect fill='#FFFFFF' height='2' style='stroke:#000000;stroke-width:1.0;' width='4' x='119' y='19'/><rect fill='#FFFFFF' height='2' style='stroke:#000000;stroke-width:1.0;' width='4' x='119' y='23'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='89' x='27' y='46.0752'>Web Servers</text><!--MD5=[7f2f8f021ba496bad1f94a1981c7f515] entity Cache--><rect fill='#FFFFFF' height='47.0146' style='stroke:#000000;stroke-width:1.0;' width='82' x='347' y='12'/><rect fill='#FFFFFF' height='10' style='stroke:#000000;stroke-width:1.0;' width='15' x='409' y='17'/><rect fill='#FFFFFF' height='2' style='stroke:#000000;stroke-width:1.0;' width='4' x='407' y='19'/><rect fill='#FFFFFF' height='2' style='stroke:#000000;stroke-width:1.0;' width='4' x='407' y='23'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='42' x='362' y='46.0752'>Cache</text><!--MD5=[d0be4d613e1b5b1a4cf9146a2f10d509] entity Databases--><rect fill='#FFFFFF' height='47.0146' style='stroke:#000000;stroke-width:1.0;' width='105' x='643' y='12'/><rect fill='#FFFFFF' height='10' style='stroke:#000000;stroke-width:1.0;' width='15' x='728' y='17'/><rect fill='#FFFFFF' height='2' style='stroke:#000000;stroke-width:1.0;' width='4' x='726' y='19'/><rect fill='#FFFFFF' height='2' style='stroke:#000000;stroke-width:1.0;' width='4' x='726' y='23'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='65' x='658' y='46.0752'>Database</text><!--MD5=[f0a1e61810f8a465ab4af215da9075dc] entity DatabaseConnection--><ellipse cx='536' cy='35.5' fill='#FFFFFF' rx='8' ry='8' style='stroke:#000000;stroke-width:1.0;'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='78' x='497' y='66.5752'>Connection</text><!--MD5=[ab28ca40ef2b4a677d73e3a83047c577] entity QueryAPI--><ellipse cx='244' cy='35.5' fill='#FFFFFF' rx='8' ry='8' style='stroke:#000000;stroke-width:1.0;'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='71' x='208.5' y='66.5752'>Query API</text><!--MD5=[437ca21d7dfb1aaaaeca6bde264e368d] link QueryAPI to Cache--><path d='M253.04,35.5 C270.76,35.5 314.18,35.5 346.82,35.5 ' fill='none' id='QueryAPI-Cache' style='stroke:#000000;stroke-width:1.0;'/><!--MD5=[56de58ffc67aa67db711628033cc3e25] link DatabaseConnection to Databases--><path d='M545.03,35.5 C562.89,35.5 607.18,35.5 642.94,35.5 ' fill='none' id='DatabaseConnection-Databases' style='stroke:#000000;stroke-width:1.0;'/><!--MD5=[de45ea8be3b80a051e7ca692938ad24c] link Cache to DatabaseConnection--><path d='M429.28,35.5 C460.27,35.5 501.19,35.5 521.85,35.5 ' fill='none' id='Cache-to-DatabaseConnection' style='stroke:#000000;stroke-width:1.0;'/><polygon fill='#000000' points='526.88,35.5,517.88,31.5,521.88,35.5,517.88,39.5,526.88,35.5' style='stroke:#000000;stroke-width:1.0;'/><!--MD5=[73c18ed0965dccf4024793734d71768c] link Server to QueryAPI--><path d='M141.01,35.5 C173.56,35.5 210.31,35.5 229.58,35.5 ' fill='none' id='Server-to-QueryAPI' style='stroke:#000000;stroke-width:1.0;'/><polygon fill='#000000' points='234.97,35.5,225.97,31.5,229.97,35.5,225.97,39.5,234.97,35.5' style='stroke:#000000;stroke-width:1.0;'/></g></svg></div><p><br /></p> <p>This will be how reads are executed for all the exercises, as this behavior is inherent to a Read-Through cache:</p> <div class="plantuml theme-plain"><svg contentScriptType='application/ecmascript' contentStyleType='text/css' height='286px' preserveAspectRatio='none' style='width:430px;height:286px;background:#FFFFFF;' version='1.1' viewBox='0 0 430 286' width='430px' xmlns:xlink='http://www.w3.org/1999/xlink' xmlns='http://www.w3.org/2000/svg' zoomAndPan='magnify'><defs/><g><rect fill='#FFFFFF' height='120.1973' style='stroke:#000000;stroke-width:1.0;' width='277.5' x='147' y='83.814'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;' x1='68' x2='68' y1='37.0146' y2='250.8105'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;' x1='195' x2='195' y1='37.0146' y2='250.8105'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;' x1='364.5' x2='364.5' y1='37.0146' y2='250.8105'/><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='96' x='20' y='5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='82' x='27' y='26.0752'>Web Server</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='96' x='20' y='249.8105'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='82' x='27' y='270.8857'>Web Server</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='56' x='167' y='5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='42' x='174' y='26.0752'>Cache</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='56' x='167' y='249.8105'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='42' x='174' y='270.8857'>Cache</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='79' x='325.5' y='5'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='65' x='332.5' y='26.0752'>Database</text><rect fill='#FFFFFF' height='31.0146' style='stroke:#000000;stroke-width:1.0;' width='79' x='325.5' y='249.8105'/><text fill='#000000' font-family='Verdana' font-size='14' lengthAdjust='spacing' textLength='65' x='332.5' y='270.8857'>Database</text><polygon fill='#000000' points='183,64.814,193,68.814,183,72.814,187,68.814' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;' x1='68' x2='189' y1='68.814' y2='68.814'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='103' x='75' y='64.0845'>Requests query</text><path d='M147,83.814 L211,83.814 L211,90.814 L201,100.814 L147,100.814 L147,83.814 ' fill='#FFFFFF' style='stroke:#000000;stroke-width:1.0;'/><rect fill='none' height='120.1973' style='stroke:#000000;stroke-width:1.0;' width='277.5' x='147' y='83.814'/><text fill='#000000' font-family='Verdana' font-size='13' font-weight='bold' lengthAdjust='spacing' textLength='19' x='162' y='97.8838'>alt</text><text fill='#000000' font-family='Verdana' font-size='11' font-weight='bold' lengthAdjust='spacing' textLength='80' x='226' y='96.873'>[cache miss]</text><polygon fill='#000000' points='353,119.4126,363,123.4126,353,127.4126,357,123.4126' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;' x1='195' x2='359' y1='123.4126' y2='123.4126'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='146' x='202' y='118.6831'>Requests query result</text><polygon fill='#000000' points='206,149.2119,196,153.2119,206,157.2119,202,153.2119' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;' x1='200' x2='364' y1='153.2119' y2='153.2119'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='85' x='212' y='148.4824'>Returns data</text><line style='stroke:#000000;stroke-width:1.0;' x1='195' x2='237' y1='183.0112' y2='183.0112'/><line style='stroke:#000000;stroke-width:1.0;' x1='237' x2='237' y1='183.0112' y2='196.0112'/><line style='stroke:#000000;stroke-width:1.0;' x1='196' x2='237' y1='196.0112' y2='196.0112'/><polygon fill='#000000' points='206,192.0112,196,196.0112,206,200.0112,202,196.0112' style='stroke:#000000;stroke-width:1.0;'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='133' x='202' y='178.2817'>Caches query result</text><polygon fill='#000000' points='79,228.8105,69,232.8105,79,236.8105,75,232.8105' style='stroke:#000000;stroke-width:1.0;'/><line style='stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;' x1='73' x2='194' y1='232.8105' y2='232.8105'/><text fill='#000000' font-family='Verdana' font-size='13' lengthAdjust='spacing' textLength='85' x='85' y='228.0811'>Returns data</text></g></svg></div> <p>Finally, our eviction strategy will be modeled by cache keys randomly being evicted. This covers both the cache running out of space and the cache failing for other reasons. As our primary concern is cache consistency with the database, and not cache availability, it’s not necessary to model capacity or more complex eviction strategies. <em>Note: If we were testing cache eviction strategies, modeling capacity would be essential.</em></p> <h2 id="summary"> <a href="#summary" class="anchor-heading" aria-labelledby="summary"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Summary </h2> <p>Now that we have our caching basics covered, let’s model them, test them, and handle the problems that arise! As usual, we will start simple and work our way up.</p> <p><br /><br /></p> <div class="table-wrapper"><table> <tbody> <tr> <td>Next: <a href="naive-model">A naive model of caching</a></td> </tr> </tbody> </table></div> <hr> <footer> <p><a href="#top" id="back-to-top">Back to top</a></p> <p class="text-small text-grey-dk-100 mb-0">Copyright &copy; 2022 Elliot Swart. Distributed by an <a href="https://github.com/ElliotSwart/pragmaticformalmodeling/blob/main/LICENSE.md">MIT license.</a> </p> <div class="d-flex mt-2"> <p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/ElliotSwart/pragmaticformalmodeling/tree/main/caching/index.md" id="edit-this-page">Edit this page on GitHub</a> </p> </div> </footer> </div> </div> </div> </body> </html>
